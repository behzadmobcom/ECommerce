@page "/Admin/Users/Purchases/{handler?}"
@model ECommerce.Front.BolouriGroup.Areas.Admin.Pages.PurchaseModel
@{
    ViewData["Title"] = "سفارشات";
    var i = 1 + (Model.PurchaseOrders.PaginationDetails.CurrentPage - 1) * Model.PurchaseOrders.PaginationDetails.PageSize; 
}
<!--begin::Title-->
<h1 class="d-flex text-dark fw-bolder fs-3 align-items-center my-1 ml-3">لیست سفارشات</h1>
<!--end::Title-->

<div class="card mb-5 mb-xl-8">
<!--begin::Body-->
<div class="card-body py-3">
<!--begin::Table container-->
<!--begin :: search options-->
 <form class="form" method="post" asp-page-handler="OnPost">
    <div class="row align-items-center">
            <div class="col-lg-10 col-xl-8">
                <div class="row align-items-center">
                     <div class="col-md-3 my-2 my-md-0">
                        <div class="d-flex align-items-center">
                            <label class="mr-3 mb-0 d-none d-md-block">از مبلغ:</label>
                            <input placeholder="مبلغ را وارد نمایید" asp-for="@Model.MinimumAmount" class="form-control" />                                
                        </div>
                    </div> 
                     <div class="col-md-3 my-2 my-md-0">
                        <div class="d-flex align-items-center">
                            <label class="mr-3 mb-0 d-none d-md-block">تا مبلغ:</label>
                            <input placeholder="مبلغ را وارد نمایید" asp-for="@Model.MaximumAmount" class="form-control" />                                
                        </div>
                    </div> 
                    <div class="col-md-3 my-2 my-md-0">
                        <div class="d-flex align-items-center">
                            <label class="mr-3 mb-0 d-none d-md-block">وضعیت فاکتور:</label>
                            <select asp-for="@Model.IsPaid" class="form-control">                               
                                <option value="null">همه</option>
                                <option value="true">پرداخت شده</option>
                                <option value="false">پرداخت نشده</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3 my-2 my-md-0">
                        <div class="d-flex align-items-center">                            
                          <div class="dropdown">
                             <label class="mr-3 mb-0 d-none d-md-block">کاربر:</label>
                              <input autocomplete="off" asp-for="@Model.Username" id="Username" class="form-control" type="text" placeholder="جستجو کاربران..." onkeyup="filterFunction()" />
                              <div id="userDropdown" class="dropdown-content">                                  
                              </div>
                          </div>
                        </div>
                    </div>
                     <div class="col-md-3 my-2 my-md-0">
                        <div class="d-flex align-items-center">
                        <label class="mr-3 d-none d-md-block" style="width: 25%">وضعیت سفارش:</label>
                            <select asp-for="@Model.Status" class="form-control">                               
                                <option value="0">فاکتورهای جدید</option>
                                <option value="1">ارسال شده</option>
                                <option value="2">تایید شده</option>
                                <option value="3">بسته شده</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4 my-2">
                        <div class="d-flex align-items-center">
                        <label class="mr-3 d-none d-md-block" style="width: 25%"> مرتب سازی بر اساس:</label>
                            <select asp-for="@Model.PurchaseSort" class="form-control">
                                <option value="7">جدید ترین</option>
                                <option value="6">قدیمی ترین</option>                                
                            </select>
                        </div>
                    </div>
                </div>   
     <input style="text-align: center; float: left;width: 25%
               " type="submit" value="بجو" class="btn btn-primary"/>
</form>
<!--begin :: search options-->
<div class="table-responsive">
<!--begin::Table-->
<table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
<!--begin::Table head-->
       <form asp-page="/Users/Purchases" method="get">
                <div class="form-actions no-color">
                    <p>
                        تعداد رکورد ها در صفحه :
                        <a asp-page="/Users/Purchases" asp-route-userName="@Model.Username" asp-route-pageSize="10">10</a> -
                        <a asp-page="/Users/Purchases" asp-route-userName="@Model.Username" asp-route-pageSize="20">20</a> -
                        <a asp-page="/Users/Purchases" asp-route-userName="@Model.Username" asp-route-pageSize="30">30</a> -
                        <a asp-page="/Users/Purchases" asp-route-userName="@Model.Username" asp-route-pageSize="40">40</a> -
                        <a asp-page="/Users/Purchases" asp-route-userName="@Model.Username" asp-route-pageSize="50">50</a>
                    </p>
                </div>
         </form>
<thead>
<tr class="fw-bolder text-muted">
	<th class="w-25px">
		#
	</th>
    <th class="min-w-150px">شماره فاکتور</th>
	<th class="min-w-150px">تاریخ خرید</th>
	<th class="min-w-140px">وضعیت سفارش</th>
	<th class="min-w-120px">وضعیت پرداخت</th>
	<th class="min-w-120px">مبلغ</th>
    <th class="min-w-120px">تخفیف</th>
	<th class="min-w-120px">کاربر</th>
	<th class="min-w-100px text-end">عملیات</th>
</tr>
</thead>

<!--end::Table head-->
<!--begin::Table body-->

<tbody>
 @foreach (var item in Model.PurchaseOrders.ReturnData)
 {        
        <tr>
	    <td>@i</td>
        <td>
		    <a href="#" class="text-dark fw-bolder text-hover-primary fs-6">@item.FBailCode</a>
	    </td>
	    <td>
            <a href="#" class="text-dark fw-bolder text-hover-primary fs-6">@item.CreationDate.ToFa()</a>
	    </td>
	    <td>
		    <a href="#" class="text-dark fw-bolder text-hover-primary d-block mb-1 fs-6">@item.Status</a>
	    </td>
	    <td>
		    <a href="#" class="text-dark fw-bolder text-hover-primary d-block mb-1 fs-6">@(item.IsPaied==true?"√":"ˣ") </a>
	    </td>
	    <td> 
		    <a href="#" class="text-dark fw-bolder text-hover-primary d-block mb-1 fs-6">@item.Amount.ToString("N0")</a>
	    </td>
	    <td class="text-dark fw-bolder text-hover-primary fs-6">@item.Discount</td>
	    <td>
		    <a href="#" class="text-dark fw-bolder text-hover-primary d-block mb-1 fs-6">@item.UserName</a>
	    </td>
	    <td class="text-end">            
		        <a asp-page="PurchaseOrder" asp-route-id="@item.Id" class="label label-inline label-light-info  font-weight-bold">جزئیات</a>           
                @if(@item.Status!=Ecommerce.Entities.Status.New){ <input value="جدید" onclick="EditPurchaseStatusById(@item.Id, 0)" type="button" class="label label-inline label-light-primary font-weight-bold" style="border: none"/> } &nbsp;
                @if(@item.Status!=Ecommerce.Entities.Status.Sent){ <input value="ارسال" onclick="EditPurchaseStatusById(@item.Id, 1)" type="button" class="label label-inline label-light-warning font-weight-bold" style="border: none"/> } &nbsp;
                @if(@item.Status!=Ecommerce.Entities.Status.Accepted){ <input value="تایید" onclick="EditPurchaseStatusById(@item.Id, 2)" type="button" class="label label-inline label-light-success font-weight-bold" style="border: none"/> } &nbsp;
                                @if (@item.Status != Ecommerce.Entities.Status.Closed)
                                {
                                    <input value="بسته شده" onclick="EditPurchaseStatusById(@item.Id, 3)" type="button" class="label label-inline label-light-danger font-weight-bold" style="border: none" />
                                } &nbsp;
	    </td>
	    </tr>
    i++;
 }
</tbody>
<!--end::Table body-->
</table>
<!--end::Table-->
    <partial name="_Pagination" model="@Model.PurchaseOrders.PaginationDetails"/>
</div>
<!--end::Table container-->
</div>
		 <div class="card-footer">
              <a class="btn btn-secondary" asp-Page="/Users/Index">لیست کاربران</a>
         </div>
<!--begin::Body-->
</div>


<script>
function EditPurchaseStatusById(id, status) {
    $.ajax({
        type: "Get",
        url: "/Admin/Users/Purchases?handler=EditPurchaseStatus&id=" + id + "&status=" + status,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (result) {
            alert(result.message);
            if (result.code === 0) {
                location.reload();
            }
        }
    });
}

function selectElement(element) {
    document.getElementById("Username").value = element.innerHTML;
    userDropdownDisply("none");
}
function userDropdownDisply(para) {
    document.getElementById("userDropdown").style.display = para
}
function filterFunction() {
    var input, filter, ul, li, a, i;
    input = document.getElementById("Username");
    if (input.value.length < 3) { userDropdownDisply("none"); }
    if (input.value.length >= 3) {
        $.ajax({
            type: "Get",
            url: "/Admin/Users/Purchases?handler=UserListBySearch&search=" + input.value,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                var userDropdownHtml = "";
                result.forEach(function (currentElement, index, array) {
                    userDropdownHtml = userDropdownHtml + " <a onclick='selectElement(this)'>" + currentElement + "</a> "
                });
                document.getElementById("userDropdown").innerHTML = userDropdownHtml;
                userDropdownDisply("block")
            }
        });
    }
    filter = input.value.toUpperCase();
    div = document.getElementById("userDropdown");
    a = div.getElementsByTagName("a");
    for (i = 0; i < a.length; i++) {
        txtValue = a[i].textContent || a[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            a[i].style.display = "";
        } else {
            a[i].style.display = "none";
        }
    }
}
</script>

<style>
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f6f6f6;
  min-width: 230px;
  overflow: auto;
  border: 1px solid #ddd;
  z-index: 1;
}

.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}
</style>